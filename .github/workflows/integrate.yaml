# Automatically build and test HeardIT back-end on push and pull-request
# using GitHub Actions.
name: HeardIT pipeline

on:
    push:
        branches: ["*"]
    pull_request:
        branches: ["*"]

env:
    # Use docker.io for Docker Hub if empty
    REGISTRY: ghcr.io
    IMAGE_NAME: jumorto/hearditbackend-image:latest
    GCP_ZONE: europe-west4
    CLUSTER_NAME: heardit-cluster-production

jobs:
    build_and_test_search_service:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: heardit_search_service
        steps:
            - name: Checkout branch
              uses: actions/checkout@v4
            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "temurin"

            - name: Setup Gradle
              uses: gradle/gradle-build-action@v3
            - name: Make gradlew executable
              run: chmod +x ./gradlew
            - name: Build with Gradle Wrapper
              run: ./gradlew build

            - name: Run Tests
              run: ./gradlew test

    build_and_test_songmanager_service:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: heardit_songmanager_service
        steps:
            - name: Checkout branch
              uses: actions/checkout@v4
            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "temurin"

            - name: Setup Gradle
              uses: gradle/gradle-build-action@v3
            - name: Make gradlew executable
              run: chmod +x ./gradlew
            - name: Build with Gradle Wrapper
              run: ./gradlew build

            - name: Run Tests
              run: ./gradlew test

    publish-docker-Hub-search-service:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: heardit_search_service
        needs: build_and_test_search_service
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Docker
              uses: docker/setup-buildx-action@v1

            - name: Build and push Docker image
              run: |
                  docker build -t jumorto/heardit-search-service .
                  docker login -u jumorto -p ${{ secrets.DOCKERHUB_TOKEN }}
                  docker push jumorto/heardit-search-service

    publish-docker-Hub-songmanager-service:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: heardit_songmanager_service
        needs: build_and_test_songmanager_service
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Docker
              uses: docker/setup-buildx-action@v1

            - name: Build and push Docker image
              run: |
                  docker build -t jumorto/heardit-songmanager-service .
                  docker login -u jumorto -p ${{ secrets.DOCKERHUB_TOKEN }}
                  docker push jumorto/heardit-songmanager-service

  deploy-to-gke:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: deploymentFiles
        needs: [publish-docker-Hub-search-service, publish-docker-Hub-songmanager-service]
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Google Cloud SDK
              uses: GoogleCloudPlatform/github-actions/setup-gcloud@v0.3.0
              with:
                  project_id: ${{ env.GCP_PROJECT_ID }}
                  service_account_key: ${{ secrets.GCP_SA_KEY }}
                  export_default_credentials: true

            - name: Configure kubectl
              uses: azure/k8s-set-context@v1
              with:
                  method: gke
                  credentials: ${{ secrets.GCP_SA_KEY }}
                  cluster_name: ${{ env.CLUSTER_NAME }}
                  location: ${{ env.GCP_ZONE }}

            - name: Apply Kubernetes configuration
              run: |
                  kubectl apply -f hearditgke.yaml
